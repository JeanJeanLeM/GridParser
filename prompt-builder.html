<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4×4 Grid Prompt Builder</title>
  <link rel="stylesheet" href="css/shared.css">
  <style>
    body {
      font-family: var(--font-sans);
      margin: 0;
      min-height: 100vh;
      background: var(--page-bg);
    }
    .hero {
      text-align: center;
      margin-bottom: var(--section-gap);
    }
    .hero__label {
      font-size: var(--text-xs);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      margin: 0 0 0.35rem 0;
    }
    .hero h1 {
      font-family: var(--font-serif);
      font-size: var(--heading-lg);
      font-weight: 700;
      margin: 0 0 0.75rem 0;
      color: var(--text-primary);
    }
    .hero .intro {
      font-size: var(--text-base);
      color: var(--text-muted);
      line-height: 1.5;
      margin: 0;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: var(--card-padding);
      margin-bottom: var(--section-gap);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card h2 {
      font-size: var(--heading-md);
      font-weight: 700;
      margin: 0 0 1rem 0;
      color: var(--text-secondary);
    }
    .form-row {
      margin-bottom: 1rem;
    }
    .form-row:last-child { margin-bottom: 0; }
    .form-row label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }
    .form-row .form-label-caps {
      font-size: var(--text-xs);
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-hint);
    }
    .form-row select,
    .form-row input[type="text"],
    .form-row textarea {
      width: 100%;
      padding: var(--input-padding);
      font-size: 0.95rem;
      border: 1px solid var(--border-input);
      border-radius: var(--radius-input);
      background: var(--card-bg);
    }
    .form-row textarea {
      font-family: inherit;
      resize: vertical;
      min-height: 0;
    }
    .form-row select:focus,
    .form-row input[type="text"]:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 2px rgba(229, 161, 82, 0.2);
    }
    .label-language-wrap { display: none; }
    .label-language-wrap.visible { display: flex; }
    /* Options pill filters (screenshot style) */
    .options-filters {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .options-filters__row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: #e8e4df;
      border: 1px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      font-size: var(--text-sm);
    }
    .filter-pill:hover { background: #dfdbd6; }
    .filter-pill:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .filter-pill__label {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-hint);
      font-family: var(--font-sans);
    }
    .filter-pill__value {
      font-weight: 700;
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    .filter-pill__input {
      border: none;
      background: transparent;
      min-width: 4ch;
      max-width: 10ch;
      font-size: var(--text-sm);
      font-weight: 700;
      color: var(--text-primary);
    }
    .filter-pill__input:focus { outline: none; }
    .filter-dropdown {
      position: relative;
      display: inline-block;
    }
    .filter-dropdown__trigger {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: #e8e4df;
      border: 1px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      font-size: var(--text-sm);
    }
    .filter-dropdown__trigger:hover { background: #dfdbd6; }
    .filter-dropdown__trigger[aria-expanded="true"] {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .filter-dropdown__list {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 0.25rem;
      min-width: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid var(--border-light);
      z-index: 50;
      max-height: 240px;
      overflow-y: auto;
      padding: 0.25rem;
    }
    .filter-dropdown__list[hidden] { display: none; }
    .filter-dropdown__option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--text-primary);
      font-weight: 500;
    }
    .filter-dropdown__option:hover {
      background: var(--input-bg);
    }
    .filter-dropdown__option--selected {
      background: #1a1a1a;
      color: #fff;
      font-weight: 600;
    }
    .filter-dropdown__option--selected::before {
      content: "✓";
      font-size: 0.85rem;
    }
    .filter-dropdown .filter-pill__chevron {
      position: static;
      margin-left: 0.15rem;
    }
    .filter-dropdown select.filter-dropdown__select-hidden {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      overflow: hidden;
      pointer-events: none;
    }
    .cells-grid {
      display: grid;
      gap: 8px;
    }
    .cells-grid.size-2 { grid-template-columns: repeat(2, 1fr); }
    .cells-grid.size-3 { grid-template-columns: repeat(3, 1fr); }
    .cells-grid.size-4 { grid-template-columns: repeat(4, 1fr); }
    .cell-box {
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 0.5rem;
      background: var(--input-bg);
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .cell-box:hover {
      border-color: #999;
      background: #eee;
    }
    .cell-box.active {
      border-color: var(--text-secondary);
      background: #e5e5e5;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }
    .cell-box .cell-num {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-hint);
      margin-bottom: 0.35rem;
    }
    .cell-box input {
      width: 100%;
      padding: 0.35rem 0.4rem;
      font-size: var(--text-xs);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.25rem;
    }
    .cell-box input:last-of-type { margin-bottom: 0; }
    .cell-box input::placeholder { color: #999; }
    .prompt-output {
      width: 100%;
      min-height: 280px;
      padding: 0.75rem;
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      line-height: 1.45;
      border: 1px solid var(--border-input);
      border-radius: var(--radius-input);
      background: var(--card-bg);
      resize: vertical;
    }
    .prompt-output:focus {
      outline: none;
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 2px rgba(229, 161, 82, 0.2);
    }
    .copy-row {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .btn {
      display: inline-block;
      padding: var(--btn-padding);
      background: var(--btn-primary-bg);
      color: #fff;
      border: none;
      border-radius: var(--radius-input);
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.15s;
    }
    .btn:hover { background: var(--btn-primary-hover); }
    .btn:focus { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .btn-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-input);
    }
    .btn-outline:hover { background: var(--input-bg); }
    .copy-feedback {
      font-size: var(--text-sm);
      color: var(--success);
      min-height: 1.5em;
    }
    .copy-feedback[aria-live="polite"] { outline: none; }
    .prompt-helper {
      margin-top: 0.75rem;
      font-size: var(--text-sm);
      color: var(--text-muted);
      line-height: 1.5;
    }
    .prompt-helper a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }
    .prompt-helper a:hover { text-decoration: underline; }
    .prompt-helper a:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .add-custom-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.35rem;
      align-items: center;
    }
    .add-custom-row input { flex: 1; margin-bottom: 0 !important; }
    .add-custom-row .btn-small {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
    }
    .cell-editor-panel {
      display: none;
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--input-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .cell-editor-panel.visible { display: block; }
    .cell-editor-panel h3 {
      font-size: 0.95rem;
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
    }
    .cell-editor-panel .form-row { margin-bottom: 0.75rem; }
    .cell-editor-panel .form-row:last-of-type { margin-bottom: 0; }
    .cell-editor-nav {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    .cell-editor-nav .btn { flex: 1; min-width: 0; }

    /* Prompt section with preview aligned alongside */
    .prompt-builder-page.main-content { max-width: 960px; }
    .prompt-and-preview {
      display: grid;
      grid-template-columns: 1fr 220px;
      gap: 2rem;
      align-items: start;
      margin-top: 0.5rem;
    }
    .style-preview {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: var(--card-padding);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .style-preview__title {
      font-size: var(--heading-md);
      font-weight: 700;
      margin: 0 0 0.35rem 0;
      color: var(--text-secondary);
    }
    .style-preview__hint {
      font-size: var(--text-xs);
      color: var(--text-muted);
      line-height: 1.4;
      margin: 0 0 1rem 0;
    }
    .style-preview__grid-showcase {
      margin-bottom: 1rem;
    }
    .style-preview__grid-label {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-hint);
      margin: 0 0 0.35rem 0;
    }
    .style-preview__grid-cells {
      display: grid;
      gap: 2px;
      width: 100%;
      max-width: 120px;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px;
      background: var(--border-light);
    }
    .style-preview__grid-cells.size-2 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .style-preview__grid-cells.size-3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
    .style-preview__grid-cells.size-4 { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); }
    .style-preview__grid-cell {
      background: var(--card-bg);
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }
    .style-preview__grid-cell img {
      width: 85%;
      height: 85%;
      object-fit: contain;
    }
    .style-preview__example { margin: 0; }
    .style-preview__bg {
      border-radius: 8px;
      padding: 1rem;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .style-preview__img-wrap {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .style-preview__img-wrap.outline-bold {
      border: 3px solid #000;
      border-radius: 6px;
    }
    .style-preview__img-wrap.outline-fine {
      border: 1px solid #333;
      border-radius: 6px;
    }
    .style-preview__img-wrap.outline-none {
      border: none;
    }
    .style-preview__img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }
    .style-preview__label {
      font-size: 0.85rem;
      font-family: var(--font-sans);
      color: #333;
      font-weight: 500;
    }
    .style-preview__label[aria-hidden="true"] { display: none; }
    .style-preview__label.visible {
      display: block;
    }
    @media (max-width: 900px) {
      .prompt-and-preview {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-header__inner">
      <a href="index.html" class="app-header__logo">Grid<span class="app-header__logo-num">2</span>Icons</a>
      <a href="index.html" class="app-header__nav">← GRID SPLITTER</a>
      <a href="premium.html" class="app-header__nav">Premium</a>
      <div class="app-header__auth">
        <span id="auth-loading" class="auth-loading">Loading…</span>
        <span id="auth-guest" class="auth-guest" style="display:none;">
          <button type="button" id="auth-btn-login" class="app-header__auth-btn">Sign in</button>
          <span class="app-header__auth-sep" aria-hidden="true">|</span>
          <button type="button" id="auth-btn-signup" class="app-header__auth-btn">Sign up</button>
        </span>
        <div id="auth-user" class="profile-dropdown" style="display:none;">
          <button type="button" id="auth-profile-trigger" class="app-header__auth-btn profile-dropdown__trigger" aria-expanded="false" aria-haspopup="true" aria-controls="auth-profile-menu">
            Signed in as <span id="auth-user-email"></span> <span class="profile-dropdown__chevron" aria-hidden="true">▼</span>
          </button>
          <div id="auth-profile-menu" class="profile-dropdown__menu" role="menu" aria-label="Account menu" hidden>
            <div class="profile-dropdown__email" id="auth-profile-email"></div>
            <a href="premium.html" class="profile-dropdown__link" role="menuitem">Premium</a>
            <button type="button" id="auth-btn-logout" class="profile-dropdown__btn" role="menuitem">Disconnect</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content prompt-builder-page">
    <div class="hero">
      <p class="hero__label" aria-hidden="true">AI PROMPT TOOL</p>
      <h1>Grid Prompt Builder</h1>
      <p class="intro">Configure style, theme and cell content – get a ready-to-use English prompt for ChatGPT or any AI image generator.</p>
    </div>

  <section class="card card--prompt-first">
    <h2>Generated prompt (English)</h2>
    <div class="prompt-and-preview">
      <div class="prompt-and-preview__main">
        <textarea class="prompt-output" id="prompt-output" aria-label="Generated prompt (editable)"></textarea>
        <div class="copy-row">
          <button type="button" class="btn btn-primary" id="copy-btn">Copy to clipboard</button>
          <span class="copy-feedback" id="copy-feedback" aria-live="polite"></span>
        </div>
        <p class="prompt-helper">You can edit the prompt above. Changing options will regenerate it. Paste into ChatGPT (DALL·E), Midjourney, or any image AI, then bring the resulting grid image back to <a href="index.html">Grid2Icons</a> to cut it into individual tiles.</p>
      </div>
      <aside class="style-preview" aria-label="Style preview example">
        <h2 class="style-preview__title">Style preview</h2>
        <p class="style-preview__hint">This example reflects your current grid size, style, background, palette, outlines and label settings.</p>
        <div class="style-preview__grid-showcase">
          <p class="style-preview__grid-label" id="style-preview-grid-label">Grid 4×4</p>
          <div class="style-preview__grid-cells" id="style-preview-grid-cells"></div>
        </div>
        <div class="style-preview__example">
          <div class="style-preview__bg" id="style-preview-bg">
            <div class="style-preview__img-wrap" id="style-preview-img-wrap">
              <img class="style-preview__img" id="style-preview-img" src="assets/preview/apple-minimalist-vector.svg" alt="Example apple icon in selected style">
            </div>
            <span class="style-preview__label" id="style-preview-label" aria-hidden="true">Apple</span>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <section class="card card--options" aria-label="Global options">
    <h2>Options</h2>
    <div class="options-filters">
      <div class="options-filters__row">
        <label class="filter-pill" for="theme">
          <span class="filter-pill__label">Theme</span>
          <input type="text" id="theme" class="filter-pill__input" placeholder="e.g. fruits" value="fruits" aria-label="Theme">
        </label>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Grid size">
            <span class="filter-pill__label">Size</span>
            <span class="filter-pill__value" data-dropdown-display>4×4</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="grid-size" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="2">2×2</option>
            <option value="3">3×3</option>
            <option value="4" selected>4×4</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Style">
            <span class="filter-pill__label">Style</span>
            <span class="filter-pill__value" data-dropdown-display>minimalist vector</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="style" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="minimalist vector">minimalist vector</option>
            <option value="watercolor">watercolor</option>
            <option value="realistic">realistic</option>
            <option value="cartoon">cartoon</option>
            <option value="sketch">sketch</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Background color">
            <span class="filter-pill__label">Background</span>
            <span class="filter-pill__value" data-dropdown-display>pure white</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="background" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="pure white">pure white</option>
            <option value="black">black</option>
            <option value="pastel">pastel</option>
            <option value="other">other</option>
          </select>
        </div>
      </div>
      <div class="options-filters__row">
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Palette">
            <span class="filter-pill__label">Palette</span>
            <span class="filter-pill__value" data-dropdown-display>flat and vivid</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="palette" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="flat and vivid">flat and vivid</option>
            <option value="soft and pastel">soft and pastel</option>
            <option value="monochrome">monochrome</option>
            <option value="natural">natural</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Outlines">
            <span class="filter-pill__label">Outlines</span>
            <span class="filter-pill__value" data-dropdown-display>bold black</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="outlines" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="bold black">bold black</option>
            <option value="fine">fine</option>
            <option value="none">none</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Labels">
            <span class="filter-pill__label">Labels</span>
            <span class="filter-pill__value" data-dropdown-display>NO</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="labels" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="NO">NO</option>
            <option value="English">English</option>
            <option value="French">French</option>
            <option value="other">other</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Anthropomorphism">
            <span class="filter-pill__label">Anthropomorphism</span>
            <span class="filter-pill__value" data-dropdown-display>Off</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="anthropomorphism" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="Off" selected>Off</option>
            <option value="On">On</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2 id="cells-heading">Grid cells 1–16</h2>
    <div class="cell-editor-panel" id="cell-editor-panel" aria-label="Edit selected cell">
      <h3 id="cell-editor-title">Edit cell 1</h3>
      <div class="form-row">
        <label for="cell-editor-name">Name</label>
        <input type="text" id="cell-editor-name" placeholder="Element name" aria-label="Cell element name">
      </div>
      <div class="form-row">
        <label for="cell-editor-desc">Description (optional)</label>
        <textarea id="cell-editor-desc" rows="3" placeholder="Description" aria-label="Cell description"></textarea>
      </div>
      <div class="cell-editor-nav">
        <button type="button" class="btn btn-outline" id="cell-editor-clear" title="Clear name and description for this cell">Clear cell</button>
        <button type="button" class="btn" id="cell-editor-prev">Previous</button>
        <button type="button" class="btn" id="cell-editor-next">Next</button>
      </div>
    </div>
    <fieldset style="border: none; padding: 0; margin: 0;">
      <legend class="sr-only" id="cells-legend">Name and optional description for each cell. Click a cell to edit.</legend>
      <div class="cells-grid size-4" id="cells-grid"></div>
    </fieldset>
  </section>

  </main>

  <script>
    (function () {
      var theme = document.getElementById('theme');
      var gridSizeSel = document.getElementById('grid-size');
      var styleSel = document.getElementById('style');
      var background = document.getElementById('background');
      var palette = document.getElementById('palette');
      var outlines = document.getElementById('outlines');
      var labels = document.getElementById('labels');
      var anthropomorphism = document.getElementById('anthropomorphism');
      var cellsGrid = document.getElementById('cells-grid');
      var cellsHeading = document.getElementById('cells-heading');
      var cellsLegend = document.getElementById('cells-legend');
      var cellEditorPanel = document.getElementById('cell-editor-panel');
      var cellEditorTitle = document.getElementById('cell-editor-title');
      var cellEditorName = document.getElementById('cell-editor-name');
      var cellEditorDesc = document.getElementById('cell-editor-desc');
      var cellEditorPrev = document.getElementById('cell-editor-prev');
      var cellEditorNext = document.getElementById('cell-editor-next');
      var cellEditorClear = document.getElementById('cell-editor-clear');
      var promptOutput = document.getElementById('prompt-output');
      var copyBtn = document.getElementById('copy-btn');
      var copyFeedback = document.getElementById('copy-feedback');
      var stylePreviewBg = document.getElementById('style-preview-bg');
      var stylePreviewImgWrap = document.getElementById('style-preview-img-wrap');
      var stylePreviewImg = document.getElementById('style-preview-img');
      var stylePreviewLabel = document.getElementById('style-preview-label');
      var stylePreviewGridLabel = document.getElementById('style-preview-grid-label');
      var stylePreviewGridCells = document.getElementById('style-preview-grid-cells');

      var currentEditorCell = 0;

      var backgroundColors = {
        'pure white': '#fff',
        'black': '#111',
        'pastel': '#f0e6fa',
        'other': '#f0f0f0'
      };
      var paletteImages = {
        'flat and vivid': 'assets/preview/apple-flat-and-vivid.png',
        'soft and pastel': 'assets/preview/apple-soft-and-pastel.png',
        'monochrome': 'assets/preview/apple-monochrome.png',
        'natural': 'assets/preview/apple-natural.png'
      };
      var styleImages = {
        'minimalist vector': 'assets/preview/apple-minimalist-vector.svg',
        'watercolor': 'assets/preview/apple-watercolor.svg',
        'realistic': 'assets/preview/apple-realistic.svg',
        'cartoon': 'assets/preview/apple-cartoon.svg',
        'sketch': 'assets/preview/apple-sketch.svg'
      };
      var labelWords = {
        'English': 'Apple',
        'French': 'Pomme',
        'other': 'Apple'
      };

      function buildGridShowcase() {
        var n = getGridSize();
        var total = n * n;
        stylePreviewGridLabel.textContent = 'Grid ' + n + '×' + n;
        stylePreviewGridCells.className = 'style-preview__grid-cells size-' + n;
        stylePreviewGridCells.innerHTML = '';
        var src = stylePreviewImg.src || styleImages[styleSel.value] || styleImages['minimalist vector'];
        for (var i = 0; i < total; i++) {
          var cell = document.createElement('div');
          cell.className = 'style-preview__grid-cell';
          if (i === 0) {
            var img = document.createElement('img');
            img.src = src;
            img.alt = '';
            cell.appendChild(img);
          }
          stylePreviewGridCells.appendChild(cell);
        }
      }

      function updatePreview() {
        var bgVal = background.value || 'pure white';
        var styleVal = styleSel.value || 'minimalist vector';
        var paletteVal = palette.value || 'flat and vivid';
        var outlineVal = outlines.value || 'bold black';
        var labelsVal = labels.value || 'NO';
        var langVal = labelsVal === 'NO' ? 'English' : labelsVal;

        stylePreviewBg.style.backgroundColor = backgroundColors[bgVal] || backgroundColors['other'];
        var imgSrc = styleImages[styleVal] || paletteImages[paletteVal] || styleImages['minimalist vector'];
        stylePreviewImg.src = imgSrc;
        stylePreviewImgWrap.className = 'style-preview__img-wrap outline-' + (outlineVal === 'bold black' ? 'bold' : outlineVal === 'fine' ? 'fine' : 'none');
        buildGridShowcase();

        if (labelsVal !== 'NO') {
          stylePreviewLabel.textContent = labelWords[langVal] || 'Apple';
          stylePreviewLabel.classList.add('visible');
          stylePreviewLabel.setAttribute('aria-hidden', 'false');
        } else {
          stylePreviewLabel.classList.remove('visible');
          stylePreviewLabel.setAttribute('aria-hidden', 'true');
        }
      }

      function getGridSize() { return Math.max(2, Math.min(4, parseInt(gridSizeSel.value, 10) || 4)); }
      function getTotalCells() { var n = getGridSize(); return n * n; }

      function syncEditorToCell() {
        if (currentEditorCell < 1) return;
        var total = getTotalCells();
        if (currentEditorCell > total) return;
        var elemEl = document.getElementById('elem-' + currentEditorCell);
        var descEl = document.getElementById('desc-' + currentEditorCell);
        if (elemEl) elemEl.value = (cellEditorName.value || '').trim();
        if (descEl) descEl.value = (cellEditorDesc.value || '').trim();
        updatePrompt();
      }

      function syncCellToEditor(idx) {
        var elemEl = document.getElementById('elem-' + idx);
        var descEl = document.getElementById('desc-' + idx);
        cellEditorName.value = elemEl ? elemEl.value : '';
        cellEditorDesc.value = descEl ? descEl.value : '';
      }

      function setEditorHighlight(idx) {
        var total = getTotalCells();
        for (var k = 1; k <= total; k++) {
          var box = document.getElementById('cell-box-' + k);
          if (box) box.classList.toggle('active', k === idx);
        }
      }

      function openEditorForCell(idx) {
        var total = getTotalCells();
        if (idx < 1 || idx > total) return;
        syncEditorToCell();
        currentEditorCell = idx;
        syncCellToEditor(idx);
        cellEditorTitle.textContent = 'Edit cell ' + idx + ' of ' + total;
        cellEditorPanel.classList.add('visible');
        setEditorHighlight(idx);
        cellEditorName.focus();
      }

      function goPrevCell() {
        var total = getTotalCells();
        if (currentEditorCell < 1) return;
        syncEditorToCell();
        currentEditorCell = currentEditorCell - 1;
        if (currentEditorCell < 1) currentEditorCell = total;
        syncCellToEditor(currentEditorCell);
        cellEditorTitle.textContent = 'Edit cell ' + currentEditorCell + ' of ' + total;
        setEditorHighlight(currentEditorCell);
        cellEditorName.focus();
      }

      function goNextCell() {
        var total = getTotalCells();
        if (currentEditorCell < 1) return;
        syncEditorToCell();
        currentEditorCell = currentEditorCell + 1;
        if (currentEditorCell > total) currentEditorCell = 1;
        syncCellToEditor(currentEditorCell);
        cellEditorTitle.textContent = 'Edit cell ' + currentEditorCell + ' of ' + total;
        setEditorHighlight(currentEditorCell);
        cellEditorName.focus();
      }

      function clearCurrentCell() {
        if (currentEditorCell < 1) return;
        cellEditorName.value = '';
        cellEditorDesc.value = '';
        syncEditorToCell();
        cellEditorName.focus();
      }


      function initFilterDropdowns() {
        document.querySelectorAll('.filter-dropdown').forEach(function (wrap) {
          var sel = wrap.querySelector('select');
          var trigger = wrap.querySelector('.filter-dropdown__trigger');
          var list = wrap.querySelector('.filter-dropdown__list');
          var display = wrap.querySelector('[data-dropdown-display]');
          if (!sel || !trigger || !list || !display) return;

          function setDisplay() {
            var opt = sel.options[sel.selectedIndex];
            display.textContent = opt ? opt.textContent : sel.value;
          }

          function buildList() {
            list.innerHTML = '';
            for (var i = 0; i < sel.options.length; i++) {
              var opt = sel.options[i];
              var div = document.createElement('div');
              div.className = 'filter-dropdown__option' + (opt.value === sel.value ? ' filter-dropdown__option--selected' : '');
              div.setAttribute('role', 'option');
              div.setAttribute('aria-selected', opt.value === sel.value);
              div.setAttribute('data-value', opt.value);
              div.textContent = opt.textContent;
              div.addEventListener('click', function () {
                var v = this.getAttribute('data-value');
                sel.value = v;
                setDisplay();
                list.querySelectorAll('.filter-dropdown__option').forEach(function (o) {
                  o.classList.toggle('filter-dropdown__option--selected', o.getAttribute('data-value') === v);
                  o.setAttribute('aria-selected', o.getAttribute('data-value') === v);
                });
                list.hidden = true;
                trigger.setAttribute('aria-expanded', 'false');
                sel.dispatchEvent(new Event('change', { bubbles: true }));
              });
              list.appendChild(div);
            }
          }

          trigger.addEventListener('click', function (e) {
            e.stopPropagation();
            var open = list.hidden === false;
            if (open) {
              list.hidden = true;
              trigger.setAttribute('aria-expanded', 'false');
            } else {
              buildList();
              list.hidden = false;
              trigger.setAttribute('aria-expanded', 'true');
            }
          });

          setDisplay();
        });

        document.addEventListener('click', function (e) {
          if (e.target.closest('.filter-dropdown')) return;
          document.querySelectorAll('.filter-dropdown__list').forEach(function (list) {
            if (!list.hidden) {
              list.hidden = true;
              var t = list.closest('.filter-dropdown').querySelector('.filter-dropdown__trigger');
              if (t) t.setAttribute('aria-expanded', 'false');
            }
          });
        });
      }

      function buildCellsGrid() {
        var n = getGridSize();
        var total = getTotalCells();
        cellsGrid.className = 'cells-grid size-' + n;
        cellsGrid.innerHTML = '';
        for (var i = 1; i <= total; i++) {
          var box = document.createElement('div');
          box.className = 'cell-box';
          box.id = 'cell-box-' + i;
          box.setAttribute('data-cell-index', i);
          box.setAttribute('role', 'button');
          box.setAttribute('tabindex', '0');
          box.setAttribute('aria-label', 'Edit cell ' + i + '. Click to open name and description.');
          box.innerHTML =
            '<span class="cell-num">CELL ' + i + '</span>' +
            '<input type="text" id="elem-' + i + '" placeholder="Element name" aria-label="Element ' + i + ' name">' +
            '<input type="hidden" id="desc-' + i + '" aria-label="Element ' + i + ' description">';
          (function (idx) {
            box.addEventListener('click', function (e) {
              e.preventDefault();
              openEditorForCell(idx);
            });
            box.addEventListener('keydown', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openEditorForCell(idx);
              }
            });
          })(i);
          cellsGrid.appendChild(box);
        }
        cellEditorPanel.classList.remove('visible');
        currentEditorCell = 0;
        cellsHeading.textContent = 'Grid cells 1–' + total;
        cellsLegend.textContent = 'Name and optional description for each of the ' + total + ' cells. Click a cell to edit.';
        attachCellListeners(total);
        updatePrompt();
      }

      function attachCellListeners(total) {
        for (var j = 1; j <= total; j++) {
          var elem = document.getElementById('elem-' + j);
          var desc = document.getElementById('desc-' + j);
          if (elem) { elem.addEventListener('input', updatePrompt); }
          if (desc) { desc.addEventListener('input', updatePrompt); }
        }
      }

      function getElementValue(id) {
        var el = document.getElementById(id);
        return el ? (el.value || '').trim() : '';
      }

      function buildPrompt() {
        var n = getGridSize();
        var total = getTotalCells();
        var themeVal = (theme.value || '').trim() || 'fruits';
        var styleVal = styleSel.value || 'minimalist vector';
        var bgVal = background.value || 'pure white';
        var paletteVal = palette.value || 'flat and vivid';
        var outlineVal = outlines.value || 'bold black';
        var labelsVal = labels.value || 'NO';
        var langVal = labelsVal === 'NO' ? 'English' : labelsVal;

        var gridDesc = n + '×' + n;
        var parts = [];
        parts.push('Create an image in a perfectly aligned ' + gridDesc + ' grid, with thin, sharp black borders between each cell and a ' + bgVal + ' background.');
        parts.push('');
        parts.push('Uniform style for all ' + total + ' illustrations: ' + styleVal + ', clean and precise lines, ' + paletteVal + ' colors, ' + outlineVal + ' outlines. No shading, no gradients, no 3D, no pixelation, no complex texture.');
        parts.push('');
        var anthropoVal = (document.getElementById('anthropomorphism') && document.getElementById('anthropomorphism').value) || 'Off';
        if (anthropoVal === 'Off') {
          parts.push('No anthropomorphism: no eyes, no face, no mouth, no arms, no human features on the illustrated elements.');
          parts.push('');
        }
        parts.push('In each cell, place a single centered element from the category ' + themeVal + ', front view, clearly recognizable shape, occupying about 80% of the cell, centered with equal margins on all sides.');
        parts.push('');
        if (labelsVal !== 'NO') {
          parts.push('Below each illustration, write the name in ' + labelsVal + ', simple black sans-serif font, uniform and readable size.');
        } else {
          parts.push('No text, numbers, or letters in the grid.');
        }
        parts.push('');
        parts.push('Exact layout of the ' + total + ' elements (name and description per cell):');
        var idx = 1;
        for (var row = 1; row <= n; row++) {
          var rowParts = [];
          for (var col = 0; col < n; col++) {
            var nameVal = getElementValue('elem-' + idx);
            var descVal = getElementValue('desc-' + idx);
            var part = idx + '. [' + nameVal + ']';
            if (descVal) part += ' — ' + descVal;
            rowParts.push(part);
            idx++;
          }
          parts.push('Row ' + row + ': ' + rowParts.join('  '));
        }
        parts.push('');
        parts.push('Perfectly square grid, strictly equal cell sizes, uniform spacing, high resolution, sharp details. No element may extend outside its cell.');

        return parts.join('\n');
      }

      function updatePrompt() {
        promptOutput.value = buildPrompt();
      }

      gridSizeSel.addEventListener('change', function () {
        buildCellsGrid();
      });

      initFilterDropdowns();

      cellEditorPrev.addEventListener('click', goPrevCell);
      cellEditorNext.addEventListener('click', goNextCell);
      cellEditorClear.addEventListener('click', clearCurrentCell);
      cellEditorName.addEventListener('input', function () {
        if (currentEditorCell >= 1) syncEditorToCell();
      });
      cellEditorDesc.addEventListener('input', function () {
        if (currentEditorCell >= 1) syncEditorToCell();
      });
      cellEditorDesc.addEventListener('keydown', function (e) {
        if (e.key === 'Tab' && !e.shiftKey) {
          e.preventDefault();
          goNextCell();
        }
      });

      var inputs = [theme, gridSizeSel, styleSel, background, palette, outlines, labels, anthropomorphism];
      inputs.forEach(function (el) {
        el.addEventListener('input', updatePrompt);
        el.addEventListener('change', updatePrompt);
      });
      [gridSizeSel, styleSel, background, palette, outlines, labels].forEach(function (el) {
        el.addEventListener('change', updatePreview);
        el.addEventListener('input', updatePreview);
      });

      buildCellsGrid();
      updatePreview();

      copyBtn.addEventListener('click', function () {
        promptOutput.select();
        promptOutput.setSelectionRange(0, 99999);
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(promptOutput.value).then(function () {
              copyFeedback.textContent = 'Copied!';
              setTimeout(function () { copyFeedback.textContent = ''; }, 2000);
            }).catch(function () {
              copyFeedback.textContent = 'Select and copy manually.';
            });
          } else {
            document.execCommand('copy');
            copyFeedback.textContent = 'Copied!';
            setTimeout(function () { copyFeedback.textContent = ''; }, 2000);
          }
        } catch (e) {
          copyFeedback.textContent = 'Select and copy manually.';
        }
      });
    })();
  </script>
  <script src="js/auth0-config.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script src="js/auth-ui.js"></script>
</body>
</html>
