<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4×4 Grid Prompt Builder</title>
  <link rel="stylesheet" href="css/shared.css">
  <script src="js/gridSchema.js"></script>
  <style>
    body {
      font-family: var(--font-sans);
      margin: 0;
      min-height: 100vh;
      background: var(--page-bg);
    }
    .hero {
      text-align: center;
      margin-bottom: var(--section-gap);
    }
    .hero__label {
      font-size: var(--text-xs);
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      margin: 0 0 0.35rem 0;
    }
    .hero h1 {
      font-family: var(--font-serif);
      font-size: var(--heading-lg);
      font-weight: 700;
      margin: 0 0 0.75rem 0;
      color: var(--text-primary);
    }
    .hero .intro {
      font-size: var(--text-base);
      color: var(--text-muted);
      line-height: 1.5;
      margin: 0;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: var(--card-padding);
      margin-bottom: var(--section-gap);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .card h2 {
      font-size: var(--heading-md);
      font-weight: 700;
      margin: 0 0 1rem 0;
      color: var(--text-secondary);
    }
    .form-row {
      margin-bottom: 1rem;
    }
    .form-row:last-child { margin-bottom: 0; }
    .form-row label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }
    .form-row .form-label-caps {
      font-size: var(--text-xs);
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-hint);
    }
    .form-row select,
    .form-row input[type="text"],
    .form-row textarea {
      width: 100%;
      padding: var(--input-padding);
      font-size: 0.95rem;
      border: 1px solid var(--border-input);
      border-radius: var(--radius-input);
      background: var(--card-bg);
    }
    .form-row textarea {
      font-family: inherit;
      resize: vertical;
      min-height: 0;
    }
    .form-row select:focus,
    .form-row input[type="text"]:focus,
    .form-row textarea:focus {
      outline: none;
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 2px rgba(229, 161, 82, 0.2);
    }
    .label-language-wrap { display: none; }
    .label-language-wrap.visible { display: flex; }
    /* Options pill filters (screenshot style) */
    .options-filters {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .options-filters__row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: #e8e4df;
      border: 1px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      font-size: var(--text-sm);
    }
    .filter-pill:hover { background: #dfdbd6; }
    .filter-pill:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .filter-pill__label {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-hint);
      font-family: var(--font-sans);
    }
    .filter-pill__value {
      font-weight: 700;
      color: var(--text-primary);
      font-size: var(--text-sm);
    }
    .filter-pill__input {
      border: none;
      background: transparent;
      min-width: 4ch;
      max-width: 10ch;
      font-size: var(--text-sm);
      font-weight: 700;
      color: var(--text-primary);
    }
    .filter-pill__input:focus { outline: none; }
    .filter-dropdown {
      position: relative;
      display: inline-block;
    }
    .filter-dropdown__trigger {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.75rem;
      border-radius: 999px;
      background: #e8e4df;
      border: 1px solid transparent;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      font-size: var(--text-sm);
    }
    .filter-dropdown__trigger:hover { background: #dfdbd6; }
    .filter-dropdown__trigger[aria-expanded="true"] {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .filter-dropdown__list {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 0.25rem;
      min-width: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      border: 1px solid var(--border-light);
      z-index: 50;
      max-height: 240px;
      overflow-y: auto;
      padding: 0.25rem;
    }
    .filter-dropdown__list[hidden] { display: none; }
    .filter-dropdown__option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--text-primary);
      font-weight: 500;
    }
    .filter-dropdown__option:hover {
      background: var(--input-bg);
    }
    .filter-dropdown__option--selected {
      background: #1a1a1a;
      color: #fff;
      font-weight: 600;
    }
    .filter-dropdown__option--selected:hover {
      background: #333;
      color: #fff;
    }
    .filter-dropdown__option--selected::before {
      content: "✓";
      font-size: 0.85rem;
    }
    .filter-dropdown .filter-pill__chevron {
      position: static;
      margin-left: 0.15rem;
    }
    .filter-dropdown select.filter-dropdown__select-hidden {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      overflow: hidden;
      pointer-events: none;
    }
    .cells-grid {
      display: grid;
      gap: 8px;
    }
    .cells-grid.size-2 { grid-template-columns: repeat(2, 1fr); }
    .cells-grid.size-3 { grid-template-columns: repeat(3, 1fr); }
    .cells-grid.size-4 { grid-template-columns: repeat(4, 1fr); }
    .cells-grid.size-5 { grid-template-columns: repeat(5, 1fr); }
    .cells-grid.size-auto {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }
    .cell-box {
      aspect-ratio: 1;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 0.5rem;
      background: var(--input-bg);
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .cell-box:hover {
      border-color: #999;
      background: #eee;
    }
    .cell-box.active {
      border-color: var(--text-secondary);
      background: #e5e5e5;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }
    .cell-box .cell-num {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-hint);
      margin-bottom: 0.35rem;
    }
    .cell-box input {
      width: 100%;
      padding: 0.35rem 0.4rem;
      font-size: var(--text-xs);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.25rem;
    }
    .cell-box input:last-of-type { margin-bottom: 0; }
    .cell-box input::placeholder { color: #999; }
    .prompt-output {
      width: 100%;
      min-height: 280px;
      padding: 0.75rem;
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      line-height: 1.45;
      border: 1px solid var(--border-input);
      border-radius: var(--radius-input);
      background: var(--card-bg);
      resize: vertical;
    }
    .prompt-output:focus {
      outline: none;
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 2px rgba(229, 161, 82, 0.2);
    }
    .copy-row {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
    }
    .btn {
      display: inline-block;
      padding: var(--btn-padding);
      background: var(--btn-primary-bg);
      color: #fff;
      border: none;
      border-radius: var(--radius-input);
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.15s;
    }
    .btn:hover { background: var(--btn-primary-hover); }
    .btn:focus { outline: 2px solid var(--focus-ring); outline-offset: 2px; }
    .btn[aria-busy="true"] { cursor: wait; }
    .btn-outline {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-input);
    }
    .btn-outline:hover { background: var(--input-bg); }
    .copy-feedback {
      font-size: var(--text-sm);
      color: var(--success);
      min-height: 1.5em;
    }
    .copy-feedback[aria-live="polite"] { outline: none; }
    .prompt-helper {
      margin-top: 0.75rem;
      font-size: var(--text-sm);
      color: var(--text-muted);
      line-height: 1.5;
    }
    .prompt-helper a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }
    .prompt-helper a:hover { text-decoration: underline; }
    .prompt-helper a:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .generated-image-area {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .generated-image-area__img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-input);
      border: 1px solid var(--border-input);
    }
    .generated-image-area__actions {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .generated-image-area__error {
      margin-top: 0.5rem;
      font-size: var(--text-sm);
      color: var(--error, #c00);
    }
    .quick-idea__hint {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin: 0 0 0.75rem 0;
      line-height: 1.4;
    }
    .quick-idea__row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .quick-idea__input {
      flex: 1;
      min-width: 200px;
      padding: var(--input-padding);
      font-size: 1rem;
      border: 1px solid var(--border-input);
      border-radius: var(--radius-input);
      background: var(--card-bg);
    }
    .quick-idea__input:focus {
      outline: none;
      border-color: var(--text-secondary);
    }
    .quick-idea__feedback {
      margin: 0.5rem 0 0 0;
      font-size: var(--text-sm);
      min-height: 1.5em;
    }
    .quick-idea__feedback.error { color: var(--error, #c00); }
    .quick-idea__feedback.success { color: var(--success, #0a0); }
    .add-custom-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.35rem;
      align-items: center;
    }
    .add-custom-row input { flex: 1; margin-bottom: 0 !important; }
    .add-custom-row .btn-small {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
    }
    .cell-editor-panel {
      display: none;
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--input-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .cell-editor-panel.visible { display: block; }
    .cell-editor-panel h3 {
      font-size: 0.95rem;
      margin: 0 0 0.75rem 0;
      color: var(--text-secondary);
    }
    .cell-editor-panel .form-row { margin-bottom: 0.75rem; }
    .cell-editor-panel .form-row:last-of-type { margin-bottom: 0; }
    .cell-editor-nav {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    .cell-editor-nav .btn { flex: 1; min-width: 0; }

    /* Prompt section with preview aligned alongside */
    .prompt-builder-page.main-content { max-width: 960px; }
    .prompt-and-preview {
      display: grid;
      grid-template-columns: 1fr 220px;
      gap: 2rem;
      align-items: start;
      margin-top: 0.5rem;
    }
    .style-preview {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: var(--card-padding);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .style-preview__title {
      font-size: var(--heading-md);
      font-weight: 700;
      margin: 0 0 0.35rem 0;
      color: var(--text-secondary);
    }
    .style-preview__hint {
      font-size: var(--text-xs);
      color: var(--text-muted);
      line-height: 1.4;
      margin: 0 0 1rem 0;
    }
    .style-preview__grid-showcase {
      margin-bottom: 1rem;
    }
    .style-preview__grid-label {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-hint);
      margin: 0 0 0.35rem 0;
    }
    .style-preview__grid-cells {
      display: grid;
      gap: 2px;
      width: 100%;
      max-width: 120px;
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 2px;
      background: var(--border-light);
    }
    .style-preview__grid-cells.size-2 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
    .style-preview__grid-cells.size-3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
    .style-preview__grid-cells.size-4 { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); }
    .style-preview__grid-cells.size-2x4 { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); }
    .style-preview__grid-cells.size-1x3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr; }
    .style-preview__grid-cell {
      background: var(--card-bg);
      border-radius: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
      position: relative;
    }
    .style-preview__grid-cell img {
      width: 85%;
      height: 85%;
      object-fit: contain;
    }
    .style-preview__grid-cell .style-preview__cell-type-label {
      font-size: 0.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      position: absolute;
      top: 2px;
      left: 2px;
      line-height: 1;
    }
    .style-preview__grid-cell.cell-type--text .style-preview__cell-type-label {
      color: #1a5fb4;
    }
    .style-preview__grid-cell.cell-type--branding .style-preview__cell-type-label {
      color: #c64600;
    }
    .style-preview__grid-cell.cell-type--text {
      background: rgba(26, 95, 180, 0.08);
    }
    .style-preview__grid-cell.cell-type--branding {
      background: rgba(198, 70, 0, 0.08);
    }
    .style-preview__grid-cell[data-cell-index] {
      cursor: pointer;
    }
    .style-preview__grid-cell.selected {
      outline: 2px solid var(--accent, #e5a152);
      outline-offset: 1px;
      z-index: 1;
    }
    .style-preview__cell-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem;
      margin-top: 0.5rem;
      font-size: var(--text-xs);
    }
    .style-preview__cell-toolbar-label { color: var(--text-hint); margin-right: 0.25rem; }
    .style-preview__cell-size-btn,
    .style-preview__cell-move-btn {
      padding: 0.2rem 0.4rem;
      font-size: 0.75rem;
      border: 1px solid var(--border-input);
      border-radius: 4px;
      background: var(--card-bg);
      cursor: pointer;
    }
    .style-preview__cell-size-btn:hover,
    .style-preview__cell-move-btn:hover {
      background: var(--input-bg);
    }
    .style-preview__cell-move-btn.active {
      background: var(--accent, #e5a152);
      color: #fff;
      border-color: var(--accent, #e5a152);
    }
    .style-preview__cell-toolbar-sep { color: var(--text-muted); margin: 0 0.2rem; }
    .style-preview__example { margin: 0; }
    .style-preview__bg {
      border-radius: 8px;
      padding: 1rem;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .style-preview__img-wrap {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .style-preview__img-wrap.outline-bold {
      border: 3px solid #000;
      border-radius: 6px;
    }
    .style-preview__img-wrap.outline-fine {
      border: 1px solid #333;
      border-radius: 6px;
    }
    .style-preview__img-wrap.outline-none {
      border: none;
    }
    .style-preview__img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }
    .style-preview__label {
      font-size: 0.85rem;
      font-family: var(--font-sans);
      color: #333;
      font-weight: 500;
    }
    .style-preview__label[aria-hidden="true"] { display: none; }
    .style-preview__label.visible {
      display: block;
    }
    @media (max-width: 900px) {
      .prompt-and-preview {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-header__inner">
      <a href="index.html" class="app-header__logo">Grid<span class="app-header__logo-num">2</span>Icons</a>
      <a href="index.html" class="app-header__nav">Grid Splitter</a>
      <a href="prompt-builder.html" class="app-header__nav">Prompt Builder</a>
      <a href="gallery.html" class="app-header__nav">Gallery</a>
      <div class="app-header__auth">
        <span id="auth-loading" class="auth-loading">Loading…</span>
        <span id="auth-guest" class="auth-guest" style="display:none;">
          <button type="button" id="auth-btn-login" class="app-header__auth-btn">Sign in</button>
          <span class="app-header__auth-sep" aria-hidden="true">|</span>
          <button type="button" id="auth-btn-signup" class="app-header__auth-btn">Sign up</button>
        </span>
        <div id="auth-user" class="profile-dropdown" style="display:none;">
          <button type="button" id="auth-profile-trigger" class="app-header__auth-btn profile-dropdown__trigger" aria-expanded="false" aria-haspopup="true" aria-controls="auth-profile-menu" title="Account menu">
            <span id="auth-user-initial" class="profile-dropdown__initial" aria-hidden="true"></span>
            <span class="profile-dropdown__chevron" aria-hidden="true">▼</span>
          </button>
          <div id="auth-profile-menu" class="profile-dropdown__menu" role="menu" aria-label="Account menu" hidden>
            <div class="profile-dropdown__email" id="auth-profile-email"></div>
            <a href="premium.html" class="profile-dropdown__link" role="menuitem">Premium</a>
            <button type="button" id="auth-btn-logout" class="profile-dropdown__btn" role="menuitem">Disconnect</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content prompt-builder-page">
    <div class="hero">
      <p class="hero__label" aria-hidden="true">AI PROMPT TOOL</p>
      <h1>Grid Prompt Builder</h1>
      <p class="intro">Configure style, theme and cell content – get a ready-to-use English prompt for ChatGPT or any AI image generator.</p>
    </div>

  <section class="card card--prompt-first">
    <h2>Generated prompt (English)</h2>
    <div class="prompt-and-preview">
      <div class="prompt-and-preview__main">
        <textarea class="prompt-output" id="prompt-output" aria-label="Generated prompt (editable)"></textarea>
        <div class="copy-row">
          <button type="button" class="btn btn-primary" id="copy-btn">Copy to clipboard</button>
          <button type="button" class="btn" id="generate-image-btn">Generate image</button>
          <span class="copy-feedback" id="copy-feedback" aria-live="polite"></span>
        </div>
        <div id="generated-image-area" class="generated-image-area" style="display:none;" aria-live="polite">
          <img id="generated-image-img" src="" alt="Generated grid image" class="generated-image-area__img">
          <div id="generated-image-actions" class="generated-image-area__actions" style="display:none;">
            <a id="generated-image-download" href="#" download="grid-image.png" class="btn btn-outline">Download</a>
            <a id="generated-image-open-grid2icons" href="index.html" class="btn">Open in Grid2Icons</a>
          </div>
          <p id="generated-image-error" class="generated-image-area__error" style="display:none;"></p>
        </div>
        <p class="prompt-helper">You can edit the prompt above. Changing options will regenerate it. Paste into ChatGPT (DALL·E), Midjourney, or any image AI, then bring the resulting grid image back to <a href="index.html">Grid2Icons</a> to cut it into individual tiles.</p>
      </div>
      <aside class="style-preview" aria-label="Style preview example">
        <h2 class="style-preview__title">Style preview</h2>
        <p class="style-preview__hint">This example reflects your current grid size, style, background, palette, outlines and label settings.</p>
        <div class="style-preview__grid-showcase">
          <p class="style-preview__grid-label" id="style-preview-grid-label">Grid 4×4</p>
          <div class="style-preview__grid-cells" id="style-preview-grid-cells"></div>
          <div class="style-preview__cell-toolbar" id="style-preview-cell-toolbar" style="display: none;">
            <span class="style-preview__cell-toolbar-label">Cell size:</span>
            <button type="button" class="style-preview__cell-size-btn" data-type="1x" title="1×">1×</button>
            <button type="button" class="style-preview__cell-size-btn" data-type="1.5x-wide" title="1.5× wide">1.5× W</button>
            <button type="button" class="style-preview__cell-size-btn" data-type="1.5x-tall" title="1.5× tall">1.5× T</button>
            <button type="button" class="style-preview__cell-size-btn" data-type="2x" title="2×">2×</button>
            <span class="style-preview__cell-toolbar-sep">|</span>
            <button type="button" class="style-preview__cell-move-btn" id="style-preview-move-btn" title="Click another cell to swap positions">Move</button>
          </div>
        </div>
        <div class="style-preview__example">
          <div class="style-preview__bg" id="style-preview-bg">
            <div class="style-preview__img-wrap" id="style-preview-img-wrap">
              <img class="style-preview__img" id="style-preview-img" src="assets/preview/apple-minimalist-vector.svg" alt="Example apple icon in selected style">
            </div>
            <span class="style-preview__label" id="style-preview-label" aria-hidden="true">Apple</span>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <section class="card card--quick-idea" aria-label="Quick idea">
    <h2>Quick idea</h2>
    <p class="quick-idea__hint">Describe what you want in one sentence; an AI will fill the grid cells for you.</p>
    <div class="quick-idea__row">
      <input type="text" id="quick-idea-input" class="quick-idea__input" placeholder="e.g. I want a set of icons for Fruits" aria-label="Quick idea description">
      <button type="button" class="btn btn-primary" id="generate-cells-btn">Generate cells</button>
    </div>
    <p id="quick-idea-feedback" class="quick-idea__feedback" aria-live="polite"></p>
  </section>

  <section class="card card--options" aria-label="Global options">
    <h2>Options</h2>
    <div class="options-filters">
      <div class="options-filters__row">
        <label class="filter-pill" for="theme">
          <span class="filter-pill__label">Theme</span>
          <input type="text" id="theme" class="filter-pill__input" placeholder="e.g. fruits" value="fruits" aria-label="Theme">
        </label>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Grid size">
            <span class="filter-pill__label">Size</span>
            <span class="filter-pill__value" data-dropdown-display>4×4</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="grid-size" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <optgroup label="2×2 (4 cells)">
              <option value="2x2">A. Classic</option>
              <option value="2x2-B">B. 1 big + 3 small</option>
            </optgroup>
            <optgroup label="3×3 (9 cells)">
              <option value="3x3">Classic</option>
              <option value="3x3-A">A. Text center</option>
              <option value="3x3-B">B. Text band</option>
              <option value="3x3-C">C. All image</option>
              <option value="3x3-D">D. Diagonal text</option>
            </optgroup>
            <optgroup label="4×4 (16 cells)">
              <option value="4x4" selected>Classic</option>
              <option value="4x4-A">A. Center 2×2 text</option>
              <option value="4x4-B">B. Vertical band text</option>
              <option value="4x4-C">C. Frame (B + IMG)</option>
            </optgroup>
            <optgroup label="Other">
              <option value="1L4S">1 large 4 smalls</option>
              <option value="3N">3 cells</option>
              <option value="custom">Custom</option>
            </optgroup>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Style">
            <span class="filter-pill__label">Style</span>
            <span class="filter-pill__value" data-dropdown-display>minimalist vector</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="style" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="minimalist vector">minimalist vector</option>
            <option value="watercolor">watercolor</option>
            <option value="realistic">realistic</option>
            <option value="cartoon">cartoon</option>
            <option value="sketch">sketch</option>
            <option value="realistic / photographic">realistic / photographic</option>
            <option value="illustration / digital painting">illustration / digital painting</option>
            <option value="3D / Pixar-style">3D / Pixar-style</option>
            <option value="anime / manga">anime / manga</option>
            <option value="comic">comic</option>
            <option value="minimalist">minimalist</option>
            <option value="flat design">flat design</option>
            <option value="cyberpunk">cyberpunk</option>
            <option value="art deco">art deco</option>
            <option value="surrealist">surrealist</option>
            <option value="watercolor / oil / charcoal">watercolor / oil / charcoal</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Background">
            <span class="filter-pill__label">Background</span>
            <span class="filter-pill__value" data-dropdown-display>pure white</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="background" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="pure white">pure white</option>
            <option value="black">black</option>
            <option value="pastel">pastel</option>
            <option value="neutral">neutral</option>
            <option value="blurred">blurred</option>
            <option value="nature">nature</option>
            <option value="futuristic city">futuristic city</option>
            <option value="white studio">white studio</option>
            <option value="specific texture">specific texture</option>
            <option value="minimalist">minimalist</option>
            <option value="very detailed">very detailed</option>
            <option value="other">other</option>
          </select>
        </div>
      </div>
      <div class="options-filters__row">
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Palette">
            <span class="filter-pill__label">Palette</span>
            <span class="filter-pill__value" data-dropdown-display>flat and vivid</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="palette" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="flat and vivid">flat and vivid</option>
            <option value="soft and pastel">soft and pastel</option>
            <option value="monochrome">monochrome</option>
            <option value="natural">natural</option>
            <option value="pastel colors">pastel colors</option>
            <option value="warm / cool tones">warm / cool tones</option>
            <option value="black and white">black and white</option>
            <option value="neon">neon</option>
            <option value="desaturated / muted">desaturated / muted</option>
            <option value="high contrast">high contrast</option>
            <option value="earth tones">earth tones</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Outlines">
            <span class="filter-pill__label">Outlines</span>
            <span class="filter-pill__value" data-dropdown-display>bold black</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="outlines" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="bold black">bold black</option>
            <option value="fine">fine</option>
            <option value="none">none</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Labels">
            <span class="filter-pill__label">Labels</span>
            <span class="filter-pill__value" data-dropdown-display>NO</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="labels" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="NO">NO</option>
            <option value="English">English</option>
            <option value="French">French</option>
            <option value="other">other</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Anthropomorphism">
            <span class="filter-pill__label">Anthropomorphism</span>
            <span class="filter-pill__value" data-dropdown-display>Off</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="anthropomorphism" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="Off" selected>Off</option>
            <option value="On">On</option>
          </select>
        </div>
      </div>
      <div class="options-filters__row">
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Lighting">
            <span class="filter-pill__label">Lighting</span>
            <span class="filter-pill__value" data-dropdown-display>natural light</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="lighting" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="natural light" selected>natural light</option>
            <option value="golden hour">golden hour</option>
            <option value="dramatic">dramatic</option>
            <option value="rim light">rim light</option>
            <option value="backlight">backlight</option>
            <option value="soft lighting">soft lighting</option>
            <option value="studio lighting">studio lighting</option>
            <option value="volumetric">volumetric</option>
            <option value="cinematic">cinematic</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Mood">
            <span class="filter-pill__label">Mood</span>
            <span class="filter-pill__value" data-dropdown-display>—</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="mood" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="—" selected>—</option>
            <option value="mysterious">mysterious</option>
            <option value="joyful">joyful</option>
            <option value="epic">epic</option>
            <option value="dark">dark</option>
            <option value="cozy">cozy</option>
            <option value="melancholic">melancholic</option>
            <option value="futuristic">futuristic</option>
            <option value="post-apocalyptic">post-apocalyptic</option>
            <option value="luxurious">luxurious</option>
            <option value="childlike">childlike</option>
          </select>
        </div>
        <div class="filter-dropdown">
          <button type="button" class="filter-dropdown__trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Max colors">
            <span class="filter-pill__label">Max colors</span>
            <span class="filter-pill__value" data-dropdown-display>—</span>
            <span class="filter-pill__chevron" aria-hidden="true">▾</span>
          </button>
          <div class="filter-dropdown__list" role="listbox" hidden></div>
          <select id="max-colors" class="filter-dropdown__select-hidden" aria-hidden="true" tabindex="-1">
            <option value="—" selected>—</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2 id="cells-heading">Grid cells 1–16</h2>
    <div class="cell-editor-panel" id="cell-editor-panel" aria-label="Edit selected cell">
      <h3 id="cell-editor-title">Edit cell 1</h3>
      <div class="form-row">
        <label for="cell-editor-name">Name</label>
        <input type="text" id="cell-editor-name" placeholder="Element name" aria-label="Cell element name">
      </div>
      <div class="form-row">
        <label for="cell-editor-desc">Description (optional)</label>
        <textarea id="cell-editor-desc" rows="3" placeholder="Description" aria-label="Cell description"></textarea>
      </div>
      <div class="cell-editor-nav">
        <button type="button" class="btn btn-outline" id="cell-editor-clear" title="Clear name and description for this cell">Clear cell</button>
        <button type="button" class="btn" id="cell-editor-prev">Previous</button>
        <button type="button" class="btn" id="cell-editor-next">Next</button>
      </div>
    </div>
    <fieldset style="border: none; padding: 0; margin: 0;">
      <legend class="sr-only" id="cells-legend">Name and optional description for each cell. Click a cell to edit.</legend>
      <div class="cells-grid size-4" id="cells-grid"></div>
    </fieldset>
  </section>

  </main>

  <script>
    (function () {
      var theme = document.getElementById('theme');
      var gridSizeSel = document.getElementById('grid-size');
      var styleSel = document.getElementById('style');
      var background = document.getElementById('background');
      var palette = document.getElementById('palette');
      var outlines = document.getElementById('outlines');
      var labels = document.getElementById('labels');
      var anthropomorphism = document.getElementById('anthropomorphism');
      var lighting = document.getElementById('lighting');
      var mood = document.getElementById('mood');
      var maxColors = document.getElementById('max-colors');
      var cellsGrid = document.getElementById('cells-grid');
      var cellsHeading = document.getElementById('cells-heading');
      var cellsLegend = document.getElementById('cells-legend');
      var cellEditorPanel = document.getElementById('cell-editor-panel');
      var cellEditorTitle = document.getElementById('cell-editor-title');
      var cellEditorName = document.getElementById('cell-editor-name');
      var cellEditorDesc = document.getElementById('cell-editor-desc');
      var cellEditorPrev = document.getElementById('cell-editor-prev');
      var cellEditorNext = document.getElementById('cell-editor-next');
      var cellEditorClear = document.getElementById('cell-editor-clear');
      var promptOutput = document.getElementById('prompt-output');
      var galleryPrompt = null;
      try { galleryPrompt = sessionStorage.getItem('galleryPrompt'); } catch (e) {}
      if (galleryPrompt) {
        promptOutput.value = galleryPrompt;
        try { sessionStorage.removeItem('galleryPrompt'); } catch (e) {}
      }
      var copyBtn = document.getElementById('copy-btn');
      var copyFeedback = document.getElementById('copy-feedback');
      var quickIdeaInput = document.getElementById('quick-idea-input');
      var generateCellsBtn = document.getElementById('generate-cells-btn');
      var quickIdeaFeedback = document.getElementById('quick-idea-feedback');
      var generateImageBtn = document.getElementById('generate-image-btn');
      var generatedImageArea = document.getElementById('generated-image-area');
      var generatedImageImg = document.getElementById('generated-image-img');
      var generatedImageDownload = document.getElementById('generated-image-download');
      var generatedImageOpenGrid2icons = document.getElementById('generated-image-open-grid2icons');
      var generatedImageActions = document.getElementById('generated-image-actions');
      var generatedImageError = document.getElementById('generated-image-error');
      var stylePreviewBg = document.getElementById('style-preview-bg');
      var stylePreviewImgWrap = document.getElementById('style-preview-img-wrap');
      var stylePreviewImg = document.getElementById('style-preview-img');
      var stylePreviewLabel = document.getElementById('style-preview-label');
      var stylePreviewGridLabel = document.getElementById('style-preview-grid-label');
      var stylePreviewGridCells = document.getElementById('style-preview-grid-cells');
      var stylePreviewCellToolbar = document.getElementById('style-preview-cell-toolbar');
      var stylePreviewMoveBtn = document.getElementById('style-preview-move-btn');

      var currentEditorCell = 0;
      var currentGridSpec = null;
      var selectedShowcaseCellIndex = null;
      var moveModeForSwap = false;

      var backgroundColors = {
        'pure white': '#fff',
        'black': '#111',
        'pastel': '#f0e6fa',
        'other': '#f0f0f0'
      };
      var paletteImages = {
        'flat and vivid': 'assets/preview/apple-flat-and-vivid.png',
        'soft and pastel': 'assets/preview/apple-soft-and-pastel.png',
        'monochrome': 'assets/preview/apple-monochrome.png',
        'natural': 'assets/preview/apple-natural.png'
      };
      var styleImages = {
        'minimalist vector': 'assets/preview/apple-minimalist-vector.svg',
        'watercolor': 'assets/preview/apple-watercolor.svg',
        'realistic': 'assets/preview/apple-realistic.svg',
        'cartoon': 'assets/preview/apple-cartoon.svg',
        'sketch': 'assets/preview/apple-sketch.svg'
      };
      var labelWords = {
        'English': 'Apple',
        'French': 'Pomme',
        'other': 'Apple'
      };

      function getGridSpec() {
        var val = gridSizeSel && gridSizeSel.value ? gridSizeSel.value : '4x4';
        if (val === 'custom' && currentGridSpec) return currentGridSpec;
        if (typeof gridSchema !== 'undefined' && gridSchema.parseCompactGrid) {
          currentGridSpec = gridSchema.parseCompactGrid(val);
          return currentGridSpec;
        }
        currentGridSpec = { mode: 'uniform', rows: 4, cols: 4, cells: [] };
        return currentGridSpec;
      }
      function setSpecToCustom(spec) {
        currentGridSpec = spec;
        if (gridSizeSel) {
          gridSizeSel.value = 'custom';
          var wrap = gridSizeSel.closest('.filter-dropdown');
          var display = wrap ? wrap.querySelector('[data-dropdown-display]') : null;
          if (display) display.textContent = 'Custom';
        }
      }
      function buildGridShowcase() {
        var spec = getGridSpec();
        spec = typeof gridSchema !== 'undefined' && gridSchema.normalizeSpec
          ? gridSchema.normalizeSpec(spec)
          : spec;
        var compact = typeof gridSchema !== 'undefined' && gridSchema.specToCompactString
          ? gridSchema.specToCompactString(spec)
          : '4x4';
        var total = typeof gridSchema !== 'undefined' && gridSchema.getCellCount
          ? gridSchema.getCellCount(spec)
          : 16;
        stylePreviewGridLabel.textContent = 'Grid ' + compact;
        var rows = spec.rows || 1;
        var cols = spec.cols || 1;
        if (spec.mode === 'uniform') {
          stylePreviewGridCells.className = 'style-preview__grid-cells size-' + rows;
          stylePreviewGridCells.style.gridTemplateColumns = '';
          stylePreviewGridCells.style.gridTemplateRows = '';
        } else if (spec.mode === 'structured') {
          stylePreviewGridCells.className = 'style-preview__grid-cells';
          stylePreviewGridCells.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)';
          stylePreviewGridCells.style.gridTemplateRows = 'repeat(' + rows + ', 1fr)';
        } else {
          stylePreviewGridCells.className = 'style-preview__grid-cells size-4';
          stylePreviewGridCells.style.gridTemplateColumns = '';
          stylePreviewGridCells.style.gridTemplateRows = '';
        }
        stylePreviewGridCells.innerHTML = '';
        var src = stylePreviewImg.src || styleImages[styleSel.value] || styleImages['minimalist vector'];
        var cells = spec.cells && spec.cells.length ? spec.cells : (function () {
          var out = [];
          for (var r = 0; r < (spec.rows || 1); r++) {
            for (var c = 0; c < (spec.cols || 1); c++) {
              out.push({ row: r, col: c, rowSpan: 1, colSpan: 1 });
            }
          }
          return out;
        })();
        for (var i = 0; i < cells.length; i++) {
          var cell = document.createElement('div');
          var ce = cells[i];
          var cellType = (ce && ce.cellType) ? ce.cellType : 'image';
          var typeLabel = cellType === 'text' ? 'TXT' : cellType === 'branding' ? 'B' : 'IMG';
          cell.className = 'style-preview__grid-cell cell-type--' + cellType + (selectedShowcaseCellIndex === i ? ' selected' : '');
          cell.setAttribute('data-cell-index', i);
          cell.setAttribute('data-cell-type', cellType);
          if (ce.row != null && ce.col != null) {
            cell.style.gridRowStart = (ce.row + 1);
            cell.style.gridColumnStart = (ce.col + 1);
            cell.style.gridRowEnd = 'span ' + (ce.rowSpan || 1);
            cell.style.gridColumnEnd = 'span ' + (ce.colSpan || 1);
          }
          var labelSpan = document.createElement('span');
          labelSpan.className = 'style-preview__cell-type-label';
          labelSpan.setAttribute('aria-hidden', 'true');
          labelSpan.textContent = typeLabel;
          cell.appendChild(labelSpan);
          if (cellType === 'image' && i === 0) {
            var img = document.createElement('img');
            img.src = src;
            img.alt = '';
            cell.appendChild(img);
          }
          (function (idx) {
            cell.addEventListener('click', function () {
              if (moveModeForSwap && selectedShowcaseCellIndex != null) {
                swapShowcaseCells(selectedShowcaseCellIndex, idx);
                moveModeForSwap = false;
                if (stylePreviewMoveBtn) stylePreviewMoveBtn.classList.remove('active');
              } else {
                selectedShowcaseCellIndex = idx;
                stylePreviewGridCells.querySelectorAll('.style-preview__grid-cell').forEach(function (el) {
                  el.classList.toggle('selected', parseInt(el.getAttribute('data-cell-index'), 10) === idx);
                });
                if (stylePreviewCellToolbar) stylePreviewCellToolbar.style.display = 'flex';
              }
            });
          })(i);
          stylePreviewGridCells.appendChild(cell);
        }
      }
      function setCellType(cellIndex, type) {
        var spec = getGridSpec();
        spec = gridSchema && gridSchema.normalizeSpec ? gridSchema.normalizeSpec(JSON.parse(JSON.stringify(spec))) : spec;
        var rows = spec.rows || 1;
        var cols = spec.cols || 1;
        var cells = spec.cells && spec.cells.length ? spec.cells.slice() : [];
        if (!cells.length) {
          for (var r = 0; r < rows; r++) {
            for (var c = 0; c < cols; c++) cells.push({ row: r, col: c, rowSpan: 1, colSpan: 1 });
          }
          cells.sort(function (a, b) { return a.row !== b.row ? a.row - b.row : a.col - b.col; });
        }
        if (cellIndex < 0 || cellIndex >= cells.length) return;
        var ce = cells[cellIndex];
        var r0 = ce.row || 0;
        var c0 = ce.col || 0;
        var rs = 1;
        var cs = 1;
        if (type === '2x') { rs = 2; cs = 2; }
        else if (type === '1.5x-wide') { cs = 2; }
        else if (type === '1.5x-tall') { rs = 2; }
        var covered = {};
        for (var ri = 0; ri < rs; ri++) {
          for (var ci = 0; ci < cs; ci++) {
            covered[(r0 + ri) + ',' + (c0 + ci)] = true;
          }
        }
        var pairs = [];
        for (var j = 0; j < cells.length; j++) {
          var cell = cells[j];
          var r = cell.row != null ? cell.row : 0;
          var c = cell.col != null ? cell.col : 0;
          if (j === cellIndex) {
            pairs.push({ cell: { row: r0, col: c0, rowSpan: rs, colSpan: cs }, oldIndex: j });
            continue;
          }
          if (covered[r + ',' + c]) continue;
          pairs.push({ cell: cell, oldIndex: j });
        }
        pairs.sort(function (a, b) {
          var ca = a.cell;
          var cb = b.cell;
          return (ca.row !== cb.row) ? ca.row - cb.row : ca.col - cb.col;
        });
        var newCells = pairs.map(function (p) { return p.cell; });
        var keptOldIndices = pairs.map(function (p) { return p.oldIndex; });
        var oldTotal = cells.length;
        var saved = [];
        for (var k = 1; k <= oldTotal; k++) {
          saved[k] = { name: getElementValue('elem-' + k), desc: getElementValue('desc-' + k) };
        }
        setSpecToCustom({ mode: 'structured', rows: rows, cols: cols, cells: newCells });
        selectedShowcaseCellIndex = null;
        if (stylePreviewCellToolbar) stylePreviewCellToolbar.style.display = 'none';
        buildGridShowcase();
        buildCellsGrid();
        for (var ni = 0; ni < keptOldIndices.length; ni++) {
          var oldI = keptOldIndices[ni];
          var nameEl = document.getElementById('elem-' + (ni + 1));
          var descEl = document.getElementById('desc-' + (ni + 1));
          if (nameEl && saved[oldI + 1]) nameEl.value = saved[oldI + 1].name || '';
          if (descEl && saved[oldI + 1]) descEl.value = saved[oldI + 1].desc || '';
        }
        updatePrompt();
      }
      function swapShowcaseCells(i, j) {
        if (i === j) return;
        var spec = getGridSpec();
        spec = gridSchema && gridSchema.normalizeSpec ? gridSchema.normalizeSpec(JSON.parse(JSON.stringify(spec))) : spec;
        var cells = spec.cells && spec.cells.length ? spec.cells.slice() : [];
        if (!spec.cells || spec.cells.length === 0) {
          var rows = spec.rows || 1;
          var cols = spec.cols || 1;
          for (var r = 0; r < rows; r++) {
            for (var c = 0; c < cols; c++) cells.push({ row: r, col: c, rowSpan: 1, colSpan: 1 });
          }
          cells.sort(function (a, b) { return a.row !== b.row ? a.row - b.row : a.col - b.col; });
        }
        if (i < 0 || i >= cells.length || j < 0 || j >= cells.length) return;
        var tmp = { row: cells[i].row, col: cells[i].col, rowSpan: cells[i].rowSpan, colSpan: cells[i].colSpan };
        cells[i] = { row: cells[j].row, col: cells[j].col, rowSpan: cells[j].rowSpan || 1, colSpan: cells[j].colSpan || 1 };
        cells[j] = { row: tmp.row, col: tmp.col, rowSpan: tmp.rowSpan || 1, colSpan: tmp.colSpan || 1 };
        setSpecToCustom({ mode: spec.mode || 'structured', rows: spec.rows, cols: spec.cols, cells: cells });
        selectedShowcaseCellIndex = null;
        if (stylePreviewCellToolbar) stylePreviewCellToolbar.style.display = 'none';
        buildGridShowcase();
        updatePrompt();
      }

      function updatePreview() {
        var bgVal = background.value || 'pure white';
        var styleVal = styleSel.value || 'minimalist vector';
        var paletteVal = palette.value || 'flat and vivid';
        var outlineVal = outlines.value || 'bold black';
        var labelsVal = labels.value || 'NO';
        var langVal = labelsVal === 'NO' ? 'English' : labelsVal;

        stylePreviewBg.style.backgroundColor = backgroundColors[bgVal] || backgroundColors['other'];
        var imgSrc = styleImages[styleVal] || paletteImages[paletteVal] || styleImages['minimalist vector'];
        stylePreviewImg.src = imgSrc;
        stylePreviewImgWrap.className = 'style-preview__img-wrap outline-' + (outlineVal === 'bold black' ? 'bold' : outlineVal === 'fine' ? 'fine' : 'none');
        buildGridShowcase();

        if (labelsVal !== 'NO') {
          stylePreviewLabel.textContent = labelWords[langVal] || 'Apple';
          stylePreviewLabel.classList.add('visible');
          stylePreviewLabel.setAttribute('aria-hidden', 'false');
        } else {
          stylePreviewLabel.classList.remove('visible');
          stylePreviewLabel.setAttribute('aria-hidden', 'true');
        }
      }

      function getTotalCells() {
        var spec = getGridSpec();
        return typeof gridSchema !== 'undefined' && gridSchema.getCellCount
          ? gridSchema.getCellCount(spec)
          : 16;
      }

      function syncEditorToCell() {
        if (currentEditorCell < 1) return;
        var total = getTotalCells();
        if (currentEditorCell > total) return;
        var elemEl = document.getElementById('elem-' + currentEditorCell);
        var descEl = document.getElementById('desc-' + currentEditorCell);
        if (elemEl) elemEl.value = (cellEditorName.value || '').trim();
        if (descEl) descEl.value = (cellEditorDesc.value || '').trim();
        updatePrompt();
      }

      function syncCellToEditor(idx) {
        var elemEl = document.getElementById('elem-' + idx);
        var descEl = document.getElementById('desc-' + idx);
        cellEditorName.value = elemEl ? elemEl.value : '';
        cellEditorDesc.value = descEl ? descEl.value : '';
      }

      function setEditorHighlight(idx) {
        var total = getTotalCells();
        for (var k = 1; k <= total; k++) {
          var box = document.getElementById('cell-box-' + k);
          if (box) box.classList.toggle('active', k === idx);
        }
      }

      function openEditorForCell(idx) {
        var total = getTotalCells();
        if (idx < 1 || idx > total) return;
        syncEditorToCell();
        currentEditorCell = idx;
        syncCellToEditor(idx);
        cellEditorTitle.textContent = 'Edit cell ' + idx + ' of ' + total;
        cellEditorPanel.classList.add('visible');
        setEditorHighlight(idx);
        cellEditorName.focus();
      }

      function goPrevCell() {
        var total = getTotalCells();
        if (currentEditorCell < 1) return;
        syncEditorToCell();
        currentEditorCell = currentEditorCell - 1;
        if (currentEditorCell < 1) currentEditorCell = total;
        syncCellToEditor(currentEditorCell);
        cellEditorTitle.textContent = 'Edit cell ' + currentEditorCell + ' of ' + total;
        setEditorHighlight(currentEditorCell);
        cellEditorName.focus();
      }

      function goNextCell() {
        var total = getTotalCells();
        if (currentEditorCell < 1) return;
        syncEditorToCell();
        currentEditorCell = currentEditorCell + 1;
        if (currentEditorCell > total) currentEditorCell = 1;
        syncCellToEditor(currentEditorCell);
        cellEditorTitle.textContent = 'Edit cell ' + currentEditorCell + ' of ' + total;
        setEditorHighlight(currentEditorCell);
        cellEditorName.focus();
      }

      function clearCurrentCell() {
        if (currentEditorCell < 1) return;
        cellEditorName.value = '';
        cellEditorDesc.value = '';
        syncEditorToCell();
        cellEditorName.focus();
      }


      function initFilterDropdowns() {
        document.querySelectorAll('.filter-dropdown').forEach(function (wrap) {
          var sel = wrap.querySelector('select');
          var trigger = wrap.querySelector('.filter-dropdown__trigger');
          var list = wrap.querySelector('.filter-dropdown__list');
          var display = wrap.querySelector('[data-dropdown-display]');
          if (!sel || !trigger || !list || !display) return;

          function setDisplay() {
            var opt = sel.options[sel.selectedIndex];
            display.textContent = opt ? opt.textContent : sel.value;
          }

          function buildList() {
            list.innerHTML = '';
            for (var i = 0; i < sel.options.length; i++) {
              var opt = sel.options[i];
              var div = document.createElement('div');
              div.className = 'filter-dropdown__option' + (opt.value === sel.value ? ' filter-dropdown__option--selected' : '');
              div.setAttribute('role', 'option');
              div.setAttribute('aria-selected', opt.value === sel.value);
              div.setAttribute('data-value', opt.value);
              div.textContent = opt.textContent;
              div.addEventListener('click', function () {
                var v = this.getAttribute('data-value');
                sel.value = v;
                setDisplay();
                list.querySelectorAll('.filter-dropdown__option').forEach(function (o) {
                  o.classList.toggle('filter-dropdown__option--selected', o.getAttribute('data-value') === v);
                  o.setAttribute('aria-selected', o.getAttribute('data-value') === v);
                });
                list.hidden = true;
                trigger.setAttribute('aria-expanded', 'false');
                sel.dispatchEvent(new Event('change', { bubbles: true }));
              });
              list.appendChild(div);
            }
          }

          trigger.addEventListener('click', function (e) {
            e.stopPropagation();
            var open = list.hidden === false;
            if (open) {
              list.hidden = true;
              trigger.setAttribute('aria-expanded', 'false');
            } else {
              buildList();
              list.hidden = false;
              trigger.setAttribute('aria-expanded', 'true');
            }
          });

          setDisplay();
        });

        document.addEventListener('click', function (e) {
          if (e.target.closest('.filter-dropdown')) return;
          document.querySelectorAll('.filter-dropdown__list').forEach(function (list) {
            if (!list.hidden) {
              list.hidden = true;
              var t = list.closest('.filter-dropdown').querySelector('.filter-dropdown__trigger');
              if (t) t.setAttribute('aria-expanded', 'false');
            }
          });
        });
      }

      function buildCellsGrid() {
        var total = getTotalCells();
        var sizeClass = (total >= 2 && total <= 5) ? 'size-' + total : 'size-auto';
        cellsGrid.className = 'cells-grid ' + sizeClass;
        cellsGrid.innerHTML = '';
        for (var i = 1; i <= total; i++) {
          var box = document.createElement('div');
          box.className = 'cell-box';
          box.id = 'cell-box-' + i;
          box.setAttribute('data-cell-index', i);
          box.setAttribute('role', 'button');
          box.setAttribute('tabindex', '0');
          box.setAttribute('aria-label', 'Edit cell ' + i + '. Click to open name and description.');
          box.innerHTML =
            '<span class="cell-num">CELL ' + i + '</span>' +
            '<input type="text" id="elem-' + i + '" placeholder="Element name" aria-label="Element ' + i + ' name">' +
            '<input type="hidden" id="desc-' + i + '" aria-label="Element ' + i + ' description">';
          (function (idx) {
            box.addEventListener('click', function (e) {
              e.preventDefault();
              openEditorForCell(idx);
            });
            box.addEventListener('keydown', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openEditorForCell(idx);
              }
            });
          })(i);
          cellsGrid.appendChild(box);
        }
        cellEditorPanel.classList.remove('visible');
        currentEditorCell = 0;
        cellsHeading.textContent = 'Grid cells 1–' + total;
        cellsLegend.textContent = 'Name and optional description for each of the ' + total + ' cells. Click a cell to edit.';
        attachCellListeners(total);
        updatePrompt();
      }

      function attachCellListeners(total) {
        for (var j = 1; j <= total; j++) {
          var elem = document.getElementById('elem-' + j);
          var desc = document.getElementById('desc-' + j);
          if (elem) { elem.addEventListener('input', updatePrompt); }
          if (desc) { desc.addEventListener('input', updatePrompt); }
        }
      }

      function getElementValue(id) {
        var el = document.getElementById(id);
        return el ? (el.value || '').trim() : '';
      }

      function buildPrompt() {
        var spec = getGridSpec();
        var total = getTotalCells();
        var compact = typeof gridSchema !== 'undefined' && gridSchema.specToCompactString
          ? gridSchema.specToCompactString(spec)
          : '4x4';
        var gridDesc = compact;
        var themeVal = (theme.value || '').trim() || 'fruits';
        var styleVal = styleSel.value || 'minimalist vector';
        var bgVal = background.value || 'pure white';
        var paletteVal = palette.value || 'flat and vivid';
        var outlineVal = outlines.value || 'bold black';
        var labelsVal = labels.value || 'NO';
        var langVal = labelsVal === 'NO' ? 'English' : labelsVal;
        var lightingVal = lighting && lighting.value ? lighting.value : 'natural light';
        var moodVal = mood && mood.value && mood.value !== '—' ? mood.value : '';
        var maxColorsVal = maxColors && maxColors.value && maxColors.value !== '—' ? maxColors.value : '';

        var gridDesc = n + '×' + n;
        var parts = [];
        parts.push('Create an image in a perfectly aligned ' + gridDesc + ' grid on a ' + bgVal + ' background. Use a single thin black line between adjacent cells only—one shared line per edge, no double lines, no extra borders. The grid is like a simple table: only these single lines separate the cells. Do not draw an outline or frame around each illustration.');
        parts.push('');
        var styleLine = 'Uniform style for all ' + total + ' illustrations: ' + styleVal + ', clean and precise lines, ' + paletteVal + ' colors' + (outlineVal !== 'none' ? ', ' + outlineVal + ' outlines on the illustrated elements' : '; no outlines or frames around each illustration') + '. Flat, no shadows, no shading, no gradients, no 3D, no pixelation, no complex texture.';
        if (moodVal) styleLine += ' Mood: ' + moodVal + '.';
        if (maxColorsVal) styleLine += ' Maximum ' + maxColorsVal + ' colors per cell.';
        parts.push(styleLine);
        parts.push('');
        var anthropoVal = (document.getElementById('anthropomorphism') && document.getElementById('anthropomorphism').value) || 'Off';
        if (anthropoVal === 'Off') {
          parts.push('No anthropomorphism: no eyes, no face, no mouth, no arms, no human features on the illustrated elements.');
          parts.push('');
        }
        parts.push('In each cell, place a single centered element from the category ' + themeVal + ', front view, clearly recognizable shape, occupying about 80% of the cell, centered with equal margins on all sides.');
        parts.push('');
        if (labelsVal !== 'NO') {
          parts.push('Below each illustration, write the name in ' + labelsVal + ', simple black sans-serif font, uniform and readable size.');
        } else {
          parts.push('No text, numbers, or letters in the grid.');
        }
        parts.push('');
        parts.push('Exact layout of the ' + total + ' elements (name and description per cell, order left-to-right top-to-bottom):');
        for (var idx = 1; idx <= total; idx++) {
          var nameVal = getElementValue('elem-' + idx);
          var descVal = getElementValue('desc-' + idx);
          var part = idx + '. [' + nameVal + ']';
          if (descVal) part += ' — ' + descVal;
          parts.push(part);
        }
        parts.push('');
        parts.push('Grid layout: ' + gridDesc + '. Single grid lines only (no double lines), high resolution, sharp details. No element may extend outside its cell.');

        return parts.join('\n');
      }

      function updatePrompt() {
        promptOutput.value = buildPrompt();
      }

      gridSizeSel.addEventListener('change', function () {
        getGridSpec();
        buildGridShowcase();
        buildCellsGrid();
      });

      if (stylePreviewCellToolbar) {
        stylePreviewCellToolbar.querySelectorAll('.style-preview__cell-size-btn').forEach(function (btn) {
          btn.addEventListener('click', function () {
            if (selectedShowcaseCellIndex == null) return;
            var type = btn.getAttribute('data-type');
            if (type) setCellType(selectedShowcaseCellIndex, type);
          });
        });
        if (stylePreviewMoveBtn) {
          stylePreviewMoveBtn.addEventListener('click', function () {
            moveModeForSwap = !moveModeForSwap;
            stylePreviewMoveBtn.classList.toggle('active', moveModeForSwap);
          });
        }
      }
      currentGridSpec = getGridSpec();

      initFilterDropdowns();

      cellEditorPrev.addEventListener('click', goPrevCell);
      cellEditorNext.addEventListener('click', goNextCell);
      cellEditorClear.addEventListener('click', clearCurrentCell);
      cellEditorName.addEventListener('input', function () {
        if (currentEditorCell >= 1) syncEditorToCell();
      });
      cellEditorDesc.addEventListener('input', function () {
        if (currentEditorCell >= 1) syncEditorToCell();
      });
      cellEditorDesc.addEventListener('keydown', function (e) {
        if (e.key === 'Tab' && !e.shiftKey) {
          e.preventDefault();
          goNextCell();
        }
      });

      var inputs = [theme, gridSizeSel, styleSel, background, palette, outlines, labels, anthropomorphism, lighting, mood, maxColors];
      inputs.forEach(function (el) {
        el.addEventListener('input', updatePrompt);
        el.addEventListener('change', updatePrompt);
      });
      [gridSizeSel, styleSel, background, palette, outlines, labels].forEach(function (el) {
        el.addEventListener('change', updatePreview);
        el.addEventListener('input', updatePreview);
      });

      buildCellsGrid();
      updatePrompt();
      updatePreview();

      var GENERATED_IMAGE_KEY = 'generatedGridImage';

      generateCellsBtn.addEventListener('click', function () {
        var description = (quickIdeaInput.value || '').trim();
        if (!description) {
          quickIdeaFeedback.textContent = 'Enter a short description first.';
          quickIdeaFeedback.className = 'quick-idea__feedback error';
          return;
        }
        quickIdeaFeedback.textContent = 'Generating…';
        quickIdeaFeedback.className = 'quick-idea__feedback';
        generateCellsBtn.disabled = true;
        var spec = getGridSpec();
        var compact = typeof gridSchema !== 'undefined' && gridSchema.specToCompactString
          ? gridSchema.specToCompactString(spec)
          : '4x4';
        var cellCount = getTotalCells();
        fetch('/api/generate-cells', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            description: description,
            gridSize: compact.indexOf('x') !== -1 && compact.length <= 3 ? parseInt(compact.split('x')[0], 10) : undefined,
            layout: compact,
            cellCount: cellCount,
          }),
        })
          .then(function (res) {
            return res.text().then(function (text) {
              var data;
              try {
                data = text ? JSON.parse(text) : {};
              } catch (e) {
                if (!res.ok) throw new Error('Server returned ' + res.status + (text ? ' (not JSON)' : ''));
                throw new Error('Invalid response');
              }
              if (!res.ok) throw new Error(data.error || data.details || 'Request failed (' + res.status + ')');
              return data;
            });
          })
          .then(function (data) {
            var cells = data.cells || [];
            var total = getTotalCells();
            for (var i = 1; i <= total; i++) {
              var c = cells[i - 1] || { name: '', description: '' };
              var elemEl = document.getElementById('elem-' + i);
              var descEl = document.getElementById('desc-' + i);
              if (elemEl) elemEl.value = c.name || '';
              if (descEl) descEl.value = c.description || '';
            }
            updatePrompt();
            if (currentEditorCell >= 1 && currentEditorCell <= total) {
              syncCellToEditor(currentEditorCell);
            }
            quickIdeaFeedback.textContent = 'Cells filled. You can edit them below.';
            quickIdeaFeedback.className = 'quick-idea__feedback success';
          })
          .catch(function (err) {
            var msg = err.message || 'Failed to generate cells.';
            if (err.message && err.message.indexOf('Failed to fetch') !== -1) {
              msg = 'Network error: is the app running with /api (e.g. Vercel or vercel dev)?';
            }
            quickIdeaFeedback.textContent = msg;
            quickIdeaFeedback.className = 'quick-idea__feedback error';
          })
          .then(function () {
            generateCellsBtn.disabled = false;
          });
      });

      generateImageBtn.addEventListener('click', function () {
        var promptText = (promptOutput.value || buildPrompt() || '').trim();
        if (!promptText) {
          generatedImageError.textContent = 'Build or paste a prompt first.';
          generatedImageError.style.display = 'block';
          generatedImageArea.style.display = 'block';
          generatedImageImg.style.display = 'none';
          generatedImageActions.style.display = 'none';
          return;
        }
        generatedImageError.style.display = 'none';
        generatedImageArea.style.display = 'block';
        generatedImageImg.style.display = 'none';
        generatedImageImg.removeAttribute('src');
        generatedImageActions.style.display = 'none';
        var btnLabel = generateImageBtn.textContent;
        generateImageBtn.disabled = true;
        generateImageBtn.setAttribute('aria-busy', 'true');
        generateImageBtn.textContent = 'Generating…';
        fetch('/api/generate-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: promptText }),
        })
          .then(function (res) {
            return res.json().then(function (data) {
              if (!res.ok) throw new Error(data.error || data.details || 'Request failed');
              return data;
            });
          })
          .then(function (data) {
            var dataUrl = null;
            if (data.imageBase64) {
              dataUrl = 'data:image/png;base64,' + data.imageBase64;
            } else if (data.imageUrl) {
              dataUrl = data.imageUrl;
            }
            if (!dataUrl) {
              throw new Error('No image in response');
            }
            generatedImageImg.src = dataUrl;
            generatedImageImg.style.display = 'block';
            generatedImageImg.alt = 'Generated grid image';
            generatedImageDownload.href = dataUrl;
            generatedImageDownload.download = 'grid-image.png';
            generatedImageActions.style.display = 'flex';
            try {
              sessionStorage.setItem(GENERATED_IMAGE_KEY, dataUrl);
            } catch (e) {}
            generatedImageError.style.display = 'none';
          })
          .catch(function (err) {
            generatedImageError.textContent = err.message || 'Failed to generate image.';
            generatedImageError.style.display = 'block';
          })
          .then(function () {
            generateImageBtn.disabled = false;
            generateImageBtn.removeAttribute('aria-busy');
            generateImageBtn.textContent = btnLabel;
          });
      });

      generatedImageOpenGrid2icons.addEventListener('click', function (e) {
        try {
          var url = sessionStorage.getItem(GENERATED_IMAGE_KEY);
          if (url) {
            sessionStorage.setItem('galleryPrompt', promptOutput.value || '');
          }
        } catch (e) {}
      });

      copyBtn.addEventListener('click', function () {
        promptOutput.select();
        promptOutput.setSelectionRange(0, 99999);
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(promptOutput.value).then(function () {
              copyFeedback.textContent = 'Copied!';
              setTimeout(function () { copyFeedback.textContent = ''; }, 2000);
            }).catch(function () {
              copyFeedback.textContent = 'Select and copy manually.';
            });
          } else {
            document.execCommand('copy');
            copyFeedback.textContent = 'Copied!';
            setTimeout(function () { copyFeedback.textContent = ''; }, 2000);
          }
        } catch (e) {
          copyFeedback.textContent = 'Select and copy manually.';
        }
      });
    })();
  </script>
  <script src="js/auth0-config.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script src="js/auth-ui.js"></script>
</body>
</html>
